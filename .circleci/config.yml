version: 2.1
commands:
   # Exercise - Rollback
   destroy_environment:
     steps:
       - run:
           name: Destroy environment
           # ${CIRCLE_WORKFLOW_ID} is a Built-in environment variable 
           # ${CIRCLE_WORKFLOW_ID:0:5} takes the first 5 chars of the variable CIRCLE_CI_WORKFLOW_ID 
           when: on_fail
           command: |
             aws cloudformation delete-stack --stack-name myStack-${CIRCLE_WORKFLOW_ID:0:7}
jobs:
 create_infrastructure: 
  docker:
   - image: amazon/aws-cli
  steps:
   - checkout
   - run:
       name: Create Cloudformation Stack
       command: |
         aws cloudformation deploy \
           --template-file template.yml \
           --stack-name myStack-${CIRCLE_WORKFLOW_ID:0:7} \
           --region us-east-1
#  configure_infrastructure: 
#     docker:
#       - image: python:3.7-alpine3.11
#     steps:
#       - checkout
#       - add_ssh_keys:
#           fingerprints: ["1f:6e:60:1c:f7:7e:19:ca:25:e0:2c:6c:9f:f9:c7:22"] # You can get this ID in the section where you registered the SSH Key
#       - run:
#           name: Install dependencies
#           command: |
#             # install dependencies needed for your playbook
#             apk add --update ansible 
#       - run:
#           name: Configure server
#           command: |
#             ansible-playbook -i inventory.txt main-remote.yml
            
# Exercise: Smoke Testing
 smoke_test:
  docker:
   - image: alpine:latest
  steps:
   - run:
       name: Test job
       # Fail the job intentionally to simulate an error.
       command:  return 1
   - destroy_environment  
            
workflows:
  # Name the workflow "welcome"
  myworkflow:
    # Run the welcome/run job in its own container
    jobs:
#     - configure_infrastructure
      - create_infrastructure
      - smoke_test

